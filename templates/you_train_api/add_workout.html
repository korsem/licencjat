{% extends 'main/base.html' %}

{% block title %}Add New Workout{% endblock %}

{% block content %}
<h1>Add New Workout</h1>

<form method="post">
    {% csrf_token %}
    {{ workout_form.as_p }}

    <h2>Segments</h2>
    <div id="segment-formset">
        {{ segment_formset.management_form }}
        {% for form in segment_formset %}
        <div class="segment-form">
            {{ form.as_p }}
            <h3>Exercises</h3>
            <div class="exercise-formset">
                {{ form.instance.exercise_formset.management_form }}
                {% for exercise_form in form.instance.exercise_formset %}
                <div class="exercise-form">
                    {{ exercise_form.as_p }}
                </div>
                {% endfor %}
                <button type="button" class="add-exercise" data-segment="{{ forloop.counter0 }}">Add Exercise</button>
            </div>
            {% if form.instance.pk %}
            <button type="button" class="delete-segment" data-segment="{{ forloop.counter0 }}">Delete Segment</button>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <button type="button" id="add-segment">Add Segment</button>
    <button type="submit" class="btn btn-primary">Save Workout</button>
</form>

<div id="exercise-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Select Exercises</h2>
        <form id="exercise-search-form">
            <input type="text" id="search-query" placeholder="Search exercises...">
            <button type="button" id="search-button">Search</button>
        </form>
        <div id="exercise-list">
            <!-- List of exercises will be loaded here -->
        </div>
    </div>
</div>

<script>
document.getElementById('add-segment').addEventListener('click', function() {
    var segmentFormset = document.getElementById('segment-formset');
    var newForm = segmentFormset.lastElementChild.cloneNode(true);
    var formIdx = segmentFormset.children.length;

    newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, formIdx);
    segmentFormset.appendChild(newForm);
});

document.querySelectorAll('.add-exercise').forEach(button => {
    button.addEventListener('click', function() {
        var segmentIndex = this.getAttribute('data-segment');
        var modal = document.getElementById('exercise-modal');
        modal.style.display = "block";

        document.getElementById('search-button').onclick = function() {
            var query = document.getElementById('search-query').value;
            fetch(`/exercise_search/?query=${query}`)
                .then(response => response.json())
                .then(data => {
                    var exerciseList = document.getElementById('exercise-list');
                    exerciseList.innerHTML = '';
                    data.forEach(exercise => {
                        var exerciseItem = document.createElement('div');
                        exerciseItem.textContent = exercise.name;
                        exerciseItem.onclick = function() {
                            // Add exercise to the formset here
                            modal.style.display = "none";
                        };
                        exerciseList.appendChild(exerciseItem);
                    });
                });
        };
    });
});

document.querySelectorAll('.delete-segment').forEach(button => {
    button.addEventListener('click', function() {
        var segmentIndex = this.getAttribute('data-segment');
        var segmentForm = document.querySelectorAll('.segment-form')[segmentIndex];
        segmentForm.remove();
    });
});

document.querySelector('.close').onclick = function() {
    document.getElementById('exercise-modal').style.display = "none";
};
</script>
{% endblock %}
